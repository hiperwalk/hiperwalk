#bidu@lncc.br, dez.2025

#docker build --build-arg USER_NAME=bidu --build-arg USER_ID=1001 --build-arg GROUP_ID=1001 -t hb:cpu . -f  buildHW_DockefFile
#docker run --rm -it hw:cpu bash
#docker run --rm -it hw:cpu /home/bidu/hiperblas-core/build/sparse_matrix_test

#docker run --rm -it hw:cpu python3 -c "import hiperblas; print(hiperblas.__file__) "
#   /home/bidu/.local/lib/python3.12/site-packages/hiperblas.cpython-312-x86_64-linux-gnu.so

#docker run --rm -it hw:cpu python3 /home/bidu/pyhiperblas/sparse_matrix_testDiagGridExp.py

#docker run --rm -it hw:cpu python3 -c "import hiperwalk; print(hiperwalk.__file__) "
#   /home/bidu/hiperwalk/hiperwalk/__init__.py

#docker run --rm -it hw:cpu python3 /home/bidu/hiperwalk/examples/coined/diagonal-grid.py

#docker run --rm -it hw:cpu /home/bidu/hiperwalk/rodarExps.sh 

#docker build --build-arg CACHE_BUST=$(date +%s) -t hw:cpu . -f  buildHW_DockefFile

#docker run --rm -it --user bidu:$(id -g) -v /prj/meus_dados/exp1:/outA hw:cpu  /home/bidu/hiperwalk/rodarExps.sh outA

#mkdir telas
#chmod 775 telas
#docker run --rm -it --user bidu:$(id -g)  -v /prj/prjedlg/bidu/OneDrive/aLncc/passeiosQuantDez25/hiperwalk/telas:/outA  hw:cpu /home/bidu/hiperwalk/rodarExps.sh outA

#FROM ubuntu:22.04
FROM ubuntu:24.04


ARG USER_NAME  #=bidu
ARG   USER_ID
ARG  GROUP_ID

#RUN apt-get update && \
#    apt-get install -y --no-install-recommends \

RUN sed -i 's|http://security.ubuntu.com/ubuntu|http://archive.ubuntu.com/ubuntu|g' /etc/apt/sources.list && \
    apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        git \
        pkg-config \
        libgtest-dev \
        ca-certificates \
        gdb && \
    rm -rf /var/lib/apt/lists/*

RUN rm -rf /var/lib/apt/lists/* && \
    apt-get clean && \
    apt-get update && \
    apt-get install -y \
        vim \
        less \
        procps \
        time \
        coreutils && \
    rm -rf /var/lib/apt/lists/*

# Usuário


# Cria grupo se não existir
RUN groupadd -g ${GROUP_ID} ${USER_NAME} || true

# Cria usuário com UID/GID desejado, sem sobrescrever se já existir
RUN id -u ${USER_NAME} &>/dev/null || \
    useradd -m -u ${USER_ID} -g ${GROUP_ID} -s /bin/bash ${USER_NAME}

# Define usuário padrão do container
USER ${USER_NAME}

#RUN if ! id -u ${USER_NAME} >/dev/null 2>&1; then \
#      groupadd -g ${GROUP_ID} ${USER_NAME} && \
#      useradd -m -u ${USER_ID} -g ${GROUP_ID} -s /bin/bash ${USER_NAME}; \
#    fi

#RUN groupadd -g ${GROUP_ID} ${USER_NAME} || true
#RUN useradd -m -u ${USER_ID} -g ${GROUP_ID} ${USER_NAME} || true
#USER ${USER_NAME}

ENV USER_NAME=${USER_NAME}


#RUN useradd -m -s /bin/bash ${USER_NAME}

ENV aWORKDIR=/home/${USER_NAME}

# Prefixo explícito
ENV HOMEu=${aWORKDIR}
ENV HIPERBLAS_PREFIX=${aWORKDIR}/hiperblas
ENV LD_LIBRARY_PATH=${HIPERBLAS_PREFIX}/lib

# Código
COPY --chown=${USER_NAME}:${USER_NAME} hiperblas-core ${aWORKDIR}/hiperblas-core

# Build e install (SEM ctest)
RUN cd ${aWORKDIR}/hiperblas-core && \
    rm -rf build && \
    mkdir build && \
    cd build && \
    cmake .. \
      -DCMAKE_INSTALL_PREFIX=${HIPERBLAS_PREFIX} \
      -DCMAKE_INSTALL_LIBDIR=lib \
      -DCMAKE_INSTALL_RPATH=${HIPERBLAS_PREFIX}/lib \
      -DCMAKE_BUILD_WITH_INSTALL_RPATH=ON \
      -DCMAKE_BUILD_TYPE=Release \
      -DBUILD_TESTING=OFF && \
    make -j$(nproc) && \
    make install

USER root

ENV HIPERBLAS_PREFIX=/home/${USER_NAME}/hiperblas
ENV C_INCLUDE_PATH=${HIPERBLAS_PREFIX}/include
ENV CPLUS_INCLUDE_PATH=${HIPERBLAS_PREFIX}/include
ENV LIBRARY_PATH=${HIPERBLAS_PREFIX}/lib
ENV LD_LIBRARY_PATH=${HIPERBLAS_PREFIX}/lib


# Python (em outra linha, como você pediu)
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        python3 \
        python3-pip \
        python3-venv \
        python3-dev && \
    rm -rf /var/lib/apt/lists/*

USER ${USER_NAME}

COPY --chown=${USER_NAME}:${USER_NAME} pyhiperblas ${aWORKDIR}/pyhiperblas

RUN cd ${aWORKDIR}/pyhiperblas && \
    python3 -m pip install --no-cache-dir \
    numpy \
    scipy \
    pytest \
    --break-system-packages

ENV LD_LIBRARY_PATH=${aWORKDIR}/hiperblas/lib

WORKDIR ${aWORKDIR}/pyhiperblas
RUN python3 -m pip install . --break-system-packages

RUN python3 -c "import hiperblas; print(hiperblas.__file__) "

ARG CACHE_BUST=1 

# Criar o diretório antes
RUN mkdir -p ${aWORKDIR}/hiperwalk && \
    chown -R ${USER_NAME}:${USER_NAME} ${aWORKDIR}

WORKDIR ${aWORKDIR}/hiperwalk

COPY --chown=${USER_NAME}:${USER_NAME} pyproject.toml ${aWORKDIR}/hiperwalk
COPY --chown=${USER_NAME}:${USER_NAME} LICENSE        ${aWORKDIR}/hiperwalk
COPY --chown=${USER_NAME}:${USER_NAME} README.md      ${aWORKDIR}/hiperwalk
COPY --chown=${USER_NAME}:${USER_NAME} rodarExps.sh   ${aWORKDIR}/hiperwalk

# Copia o pacote Python
COPY --chown=${USER_NAME}:${USER_NAME} hiperwalk ./hiperwalk

# (opcional) exemplos
COPY --chown=${USER_NAME}:${USER_NAME} examples ./examples

#RUN python3 -m pip install --upgrade pip
RUN python3 -m pip install . --break-system-packages

RUN python3 -c "import hiperwalk; print(hiperwalk.__file__) "


